<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéß –ü–ª–µ–µ—Ä –∏–∑ Google Drive</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 700px;
      margin: 1.5rem auto;
      padding: 0 1rem;
      text-align: center;
      background: #fafafa;
      color: #333;
    }
    h1 { font-weight: 600; margin-bottom: 1rem; }
    .folder-input {
      margin: 1.5rem 0;
    }
    .folder-input label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    .folder-input input {
      width: 100%;
      max-width: 500px;
      padding: 0.6rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background: #4285f4;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 1.05rem;
      border-radius: 4px;
      cursor: pointer;
      margin: 0.5rem;
      transition: background 0.2s;
    }
    button:hover { background: #3367d6; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .controls {
      margin: 1rem 0;
    }
    .status { margin-top: 1rem; min-height: 1.4em; }
    .song-list {
      margin-top: 1.5rem;
      text-align: left;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }
    .song-item {
      padding: 0.4rem 0.6rem;
      background: #f1f8ff;
      margin: 0.3rem 0;
      border-radius: 3px;
      cursor: pointer;
    }
    .song-item:hover { background: #e0f0ff; }
    .song-item.playing { background: #d0e7ff; font-weight: bold; }
    .progress-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #4285f4;
      cursor: pointer;
    }
    .progress-container input[type="range"]::-moz-range-thumb {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #4285f4;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>üéß –ü–ª–µ–µ—Ä –∏–∑ Google Drive</h1>

  <div class="folder-input">
    <label for="folderId">ID –ø–∞–ø–∫–∏ –≤ Google Drive:</label>
    <input type="text" id="folderId" 
           value="12OvdZiyaAjaSW1W3Pm3O6M-ekZYk4-am" 
           placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1AbC_xYz9...">
  </div>

  <button id="loadBtn">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–µ—Å–µ–Ω</button>
  <button id="playBtn" disabled>‚ñ∂Ô∏è –°—ã–≥—Ä–∞—Ç—å —Å–ª—É—á–∞–π–Ω—É—é</button>

  <div class="controls">
    <label><input type="checkbox" id="shuffle" checked> –°–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫</label>
    <label><input type="checkbox" id="loop" checked> –ü–æ–≤—Ç–æ—Ä—è—Ç—å</label>
  </div>

  <div class="status" id="status">–í–≤–µ–¥–∏—Ç–µ ID –ø–∞–ø–∫–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª</div>

  <div class="song-list" id="songList"></div>
  <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
  <div class="progress-container" style="max-width:500px; margin:1rem auto; padding:0 1rem;">
    <div style="display:flex; justify-content:space-between; font-size:0.85rem; color:#666;">
      <span id="currentTime">0:00</span>
      <span id="duration">0:00</span>
    </div>
    <input type="range" id="progress" value="0" min="0" max="100" 
           style="width:100%; margin:0.5rem 0; height:6px; -webkit-appearance:none; background:#eee; border-radius:3px;" />
  </div>

  <audio id="player" style="display:none"></audio>

  <script>
    // ‚Äî‚Äî‚Äî –ö–û–ù–§–ò–ì ‚Äî‚Äî‚Äî
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyUK2uAIzpMejSMckdPx0g1bs__J5Zxh2kif6b8cITYfHwrYKWsxG92s4tAC-B4y3j9/exec';
    
    let songs = [];
    let currentIndex = -1;
    let isPlaying = false;
    const player = document.getElementById('player');
    const folderIdInput = document.getElementById('folderId');
    const loadBtn = document.getElementById('loadBtn');
    const playBtn = document.getElementById('playBtn');
    const statusEl = document.getElementById('status');
    const songListEl = document.getElementById('songList');
    const shuffleCheck = document.getElementById('shuffle');
    const loopCheck = document.getElementById('loop');
    const progressInput = document.getElementById('progress');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');

    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞
    async function loadSongs() {
      const folderId = folderIdInput.value.trim();
      if (!folderId) {
        statusEl.textContent = '‚ùå –£–∫–∞–∂–∏—Ç–µ ID –ø–∞–ø–∫–∏';
        return;
      }

      statusEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞‚Ä¶';
      loadBtn.disabled = true;

      try {
        const url = `${SCRIPT_URL}?folderId=${encodeURIComponent(folderId)}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.error) throw new Error(data.error);

        songs = data;
        renderSongList();
        playBtn.disabled = songs.length === 0; // –∞–∫—Ç–∏–≤–Ω–∞, –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã 1 –ø–µ—Å–Ω—è
        statusEl.textContent = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${songs.length} –ø–µ—Å–µ–Ω`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = `‚ùå –û—à–∏–±–∫–∞: ${err.message || '–Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å'}`;
        songs = [];
        playBtn.disabled = true;
      } finally {
        loadBtn.disabled = false;
      }
    }

    function renderSongList() {
      songListEl.innerHTML = songs.length 
        ? `<h3>–ü–µ—Å–Ω–∏ (${songs.length}):</h3>` 
        : '';
      
      songs.forEach((song, i) => {
        const div = document.createElement('div');
        div.className = 'song-item';
        div.textContent = song.name;
        div.onclick = () => playSong(i);
        songListEl.appendChild(div);
      });
    }

    // –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    function playSong(index) {
      if (index < 0 || index >= songs.length) return;
      
      currentIndex = index;
      const song = songs[index];
      
      const directUrl = `https://drive.google.com/uc?export=download&id=${song.id}&confirm=t`;
      const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(directUrl);
      
      player.src = proxyUrl;
      statusEl.textContent = `‚ñ∂Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞: ${song.name}‚Ä¶`;

      player.play()
        .then(() => {
          statusEl.textContent = `‚ñ∂Ô∏è –ò–≥—Ä–∞–µ—Ç: ${song.name}`;
          playBtn.textContent = '‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
          isPlaying = true;
          highlightCurrent(index);
        })
        .catch(err => {
          statusEl.textContent = `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å: ${song.name} (${err.name})`;
        });
    }

    function highlightCurrent(index) {
      document.querySelectorAll('.song-item').forEach((el, i) => {
        el.classList.toggle('playing', i === index);
      });
    }

    function playNextSong() {
      if (songs.length === 0) return;
      
      let nextIndex;
      if (shuffleCheck.checked) {
        do { nextIndex = Math.floor(Math.random() * songs.length); }
        while (songs.length > 1 && nextIndex === currentIndex);
      } else {
        nextIndex = (currentIndex + 1) % songs.length;
      }
      playSong(nextIndex);
    }

    function togglePlayback() {
      if (isPlaying) {
        player.pause();
        player.src = '';
        isPlaying = false;
        playBtn.textContent = '‚ñ∂Ô∏è –°—ã–≥—Ä–∞—Ç—å —Å–ª—É—á–∞–π–Ω—É—é';
        statusEl.textContent = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
        document.querySelectorAll('.song-item').forEach(el => el.classList.remove('playing'));
      } else {
        if (songs.length === 0) {
          alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å–ø–∏—Å–æ–∫ –ø–µ—Å–µ–Ω!');
          return;
        }
        const index = Math.floor(Math.random() * songs.length); // –≤—Å–µ–≥–¥–∞ —Å–ª—É—á–∞–π–Ω–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        playSong(index);
      }
    }
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏: —Å–µ–∫—É–Ω–¥—ã ‚Üí MM:SS
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ –∏ –≤—Ä–µ–º–µ–Ω–∏
    player.addEventListener('timeupdate', () => {
      if (player.duration) {
        const percent = (player.currentTime / player.duration) * 100;
        progressInput.value = percent;
        currentTimeEl.textContent = formatTime(player.currentTime);
      }
    });
    
    player.addEventListener('loadedmetadata', () => {
      durationEl.textContent = formatTime(player.duration || 0);
      progressInput.max = player.duration || 100;
    });
    
    player.addEventListener('ended', () => {
      progressInput.value = 0;
      currentTimeEl.textContent = '0:00';
      if (loopCheck.checked) playNextSong();
      else togglePlayback();
    });
    
    // –ü—Ä–æ–º–æ—Ç–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –ø–æ–ª–∑—É–Ω–∫–∞
    progressInput.addEventListener('input', () => {
      const percent = progressInput.value;
      const time = (percent / 100) * (player.duration || 0);
      player.currentTime = time;
    });
    
    // –ü–ª–∞–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ drag (–Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏–∏)
    progressInput.addEventListener('mousedown', () => {
      player.pause(); // –ø–∞—É–∑–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –ø—Ä–æ–º–æ—Ç–∫–∏ (–ø–æ –∂–µ–ª–∞–Ω–∏—é)
    });
    progressInput.addEventListener('mouseup', () => {
      if (isPlaying) player.play();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    player.onended = () => {
      if (loopCheck.checked) playNextSong();
      else togglePlayback();
    };

    loadBtn.addEventListener('click', loadSongs);
    playBtn.addEventListener('click', togglePlayback);

    // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    // loadSongs(); // —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
  </script>
</body>
</html>
