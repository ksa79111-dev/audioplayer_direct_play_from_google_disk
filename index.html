<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéß –°–ª—É—á–∞–π–Ω–∞—è –ø–µ—Å–Ω—è</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 700px;
      margin: 2rem auto;
      padding: 0 1rem;
      text-align: center;
      background: #fafafa;
      color: #333;
    }
    h1 {
      font-weight: 600;
      margin-bottom: 1.5rem;
    }
    button {
      background: #4285f4;
      color: white;
      border: none;
      padding: 0.8rem 1.8rem;
      font-size: 1.1rem;
      border-radius: 6px;
      cursor: pointer;
      margin: 1rem 0;
      transition: background 0.2s;
    }
    button:hover {
      background: #3367d6;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #status {
      margin-top: 1.5rem;
      font-size: 1.1rem;
      min-height: 1.5em;
    }
    .progress {
      width: 80%;
      max-width: 400px;
      height: 6px;
      background: #eee;
      border-radius: 3px;
      margin: 1rem auto;
      display: none;
    }
    .progress-bar {
      height: 100%;
      background: #4285f4;
      border-radius: 3px;
      width: 0%;
      transition: width 0.1s;
    }
  </style>
</head>
<body>
  <h1>üéß –°–ª—É—á–∞–π–Ω–∞—è –ø–µ—Å–Ω—è</h1>
  <button id="playBtn">–°—ã–≥—Ä–∞—Ç—å —Å–ª—É—á–∞–π–Ω—É—é –ø–µ—Å–Ω—é</button>
  <div class="progress" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div id="status">–ì–æ—Ç–æ–≤–æ</div>

  <script>
    // ‚Äî‚Äî‚Äî –°–ü–ò–°–û–ö –í–ê–®–ò–• –ü–ï–°–ï–ù ‚Äî‚Äî‚Äî
    const songs = [
      { id: "1aVQDA7YIZ_9-x8XKc68wrDbgR-8SHTLI", name: "mix.mp3" },
      { id: "1Gsk4HO7GXi0o18z5bESw2Iqe8cJc4hmg", name: "Dan Balan - Lendo Calendo" },
      { id: "1JA84mlS_3I8PGwOXeZa3l8XqYiIGdmpn", name: "DVBBS - Tsunami" },
      { id: "1-4cojYT8WyLgfRqcFON2LKqybWSCh4OL", name: "The Hardkiss - Make Up" }
    ];

    let audioContext = null;
    let currentSource = null;

    function updateProgress(percent) {
      const bar = document.getElementById('progressBar');
      bar.style.width = percent + '%';
    }

    async function playRandomSong() {
      const btn = document.getElementById('playBtn');
      const status = document.getElementById('status');
      const progressContainer = document.getElementById('progressContainer');

      btn.disabled = true;
      status.textContent = '–í—ã–±–æ—Ä –ø–µ—Å–Ω–∏‚Ä¶';
      progressContainer.style.display = 'block';
      updateProgress(5);

      // –°–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä
      const song = songs[Math.floor(Math.random() * songs.length)];
      status.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞: ${song.name}‚Ä¶`;

      // ‚úÖ –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ + –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
      const directUrl = `https://drive.google.com/uc?export=download&id=${song.id}&confirm=t`;
      const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(directUrl);

      updateProgress(20);

      try {
        // –ó–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        updateProgress(40);

        // –ß–∏—Ç–∞–µ–º –∫–∞–∫ –º–∞—Å—Å–∏–≤ –±–∞–π—Ç —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
        const contentLength = +response.headers.get('content-length') || 1;
        const reader = response.body.getReader();
        const chunks = [];
        let receivedLength = 0;

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          chunks.push(value);
          receivedLength += value.length;
          const percent = 40 + Math.min(50, Math.round((receivedLength / contentLength) * 50));
          updateProgress(percent);
        }

        const arrayBuffer = new Uint8Array(receivedLength);
        let offset = 0;
        for (const chunk of chunks) {
          arrayBuffer.set(chunk, offset);
          offset += chunk.length;
        }

        updateProgress(90);

        // ‚Äî‚Äî‚Äî –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Web Audio API ‚Äî‚Äî‚Äî
        if (audioContext) {
          try { audioContext.close(); } catch (e) {}
        }
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        const buffer = await audioContext.decodeAudioData(arrayBuffer.buffer);
        const source = audioContext.createBufferSource();
        source.buffer = buffer;
        source.connect(audioContext.destination);

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π, –µ—Å–ª–∏ –±—ã–ª
        if (currentSource) currentSource.stop();
        currentSource = source;

        // ‚ñ∂Ô∏è –ê–≤—Ç–æ–ø–ª–µ–π ‚Äî —Ä–∞–∑—Ä–µ—à—ë–Ω –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞
        await audioContext.resume();
        source.start(0);

        updateProgress(100);
        status.innerHTML = `‚ñ∂Ô∏è <strong>–ò–≥—Ä–∞–µ—Ç:</strong> ${song.name}`;
        btn.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
        btn.disabled = false;
        btn.onclick = stopPlayback;

      } catch (err) {
        console.error('Playback error:', err);
        status.textContent = `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∏–≥—Ä–∞—Ç—å: ${err.message || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
        btn.disabled = false;
        btn.textContent = '–°—ã–≥—Ä–∞—Ç—å —Å–ª—É—á–∞–π–Ω—É—é –ø–µ—Å–Ω—é';
        btn.onclick = playRandomSong;
        progressContainer.style.display = 'none';
      }
    }

    function stopPlayback() {
      if (audioContext) {
        audioContext.close().catch(() => {});
        audioContext = null;
        currentSource = null;
      }
      document.getElementById('playBtn').textContent = '–°—ã–≥—Ä–∞—Ç—å —Å–ª—É—á–∞–π–Ω—É—é –ø–µ—Å–Ω—é';
      document.getElementById('playBtn').onclick = playRandomSong;
      document.getElementById('status').textContent = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
      document.getElementById('progressContainer').style.display = 'none';
    }

    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    document.getElementById('playBtn').addEventListener('click', playRandomSong);
  </script>
</body>
</html>
